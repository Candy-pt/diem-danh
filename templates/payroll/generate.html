{% extends "base.html" %}

{% block title %}Tính lương - Hệ thống Quản lý Nhân sự{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Tính lương</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('payroll.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-1"></i>Quay lại
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i>Tính lương tháng
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="payrollForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="month" class="form-label">Tháng <span class="text-danger">*</span></label>
                            <select class="form-select" id="month" name="month" required>
                                <option value="">Chọn tháng</option>
                                <option value="1">Tháng 1</option>
                                <option value="2">Tháng 2</option>
                                <option value="3">Tháng 3</option>
                                <option value="4">Tháng 4</option>
                                <option value="5">Tháng 5</option>
                                <option value="6">Tháng 6</option>
                                <option value="7">Tháng 7</option>
                                <option value="8">Tháng 8</option>
                                <option value="9">Tháng 9</option>
                                <option value="10">Tháng 10</option>
                                <option value="11">Tháng 11</option>
                                <option value="12">Tháng 12</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="year" class="form-label">Năm <span class="text-danger">*</span></label>
                            <select class="form-select" id="year" name="year" required>
                                <option value="">Chọn năm</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Chọn nhân viên <span class="text-danger">*</span></label>
                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label fw-bold" for="selectAll">
                                    Chọn tất cả
                                </label>
                            </div>
                            <hr>
                            {% for employee in employees %}
                            <div class="form-check mb-2">
                                <input class="form-check-input employee-checkbox" type="checkbox" 
                                       name="employee_ids" value="{{ employee.id }}" id="emp_{{ employee.id }}">
                                <label class="form-check-label" for="emp_{{ employee.id }}">
                                    <strong>{{ employee.employee_id }}</strong> - 
                                    {{ employee.first_name }} {{ employee.last_name }} 
                                    <span class="badge bg-primary">{{ employee.department }}</span>
                                    <span class="badge bg-info">{{ employee.position }}</span>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="history.back()">
                            <i class="fas fa-times me-1"></i>Hủy
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-calculator me-1"></i>Tính lương
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Hướng dẫn
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-lightbulb me-1"></i>Lưu ý:</h6>
                    <ul class="mb-0">
                        <li>Chọn tháng và năm cần tính lương</li>
                        <li>Chọn nhân viên cần tính lương</li>
                        <li>Hệ thống sẽ tự động tính dựa trên dữ liệu chấm công</li>
                        <li>Lương được tính theo công thức: Lương cơ bản + Phụ cấp + OT - Khấu trừ</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-1"></i>Quan trọng:</h6>
                    <ul class="mb-0">
                        <li>Chỉ tính lương cho nhân viên đang làm việc</li>
                        <li>Dữ liệu chấm công phải có đầy đủ</li>
                        <li>Không thể tính lương trùng tháng</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Set current month and year as default
    var now = new Date();
    $('#month').val(now.getMonth() + 1);
    $('#year').val(now.getFullYear());
    
    // Select all functionality
    $('#selectAll').change(function() {
        $('.employee-checkbox').prop('checked', $(this).is(':checked'));
    });
    
    // Update select all when individual checkboxes change
    $('.employee-checkbox').change(function() {
        var totalCheckboxes = $('.employee-checkbox').length;
        var checkedCheckboxes = $('.employee-checkbox:checked').length;
        
        if (checkedCheckboxes === totalCheckboxes) {
            $('#selectAll').prop('checked', true);
        } else {
            $('#selectAll').prop('checked', false);
        }
    });
    
    // Form validation
    $('#payrollForm').on('submit', function(e) {
        var month = $('#month').val();
        var year = $('#year').val();
        var selectedEmployees = $('.employee-checkbox:checked').length;
        
        if (!month || !year) {
            alert('Vui lòng chọn tháng và năm!');
            e.preventDefault();
            return;
        }
        
        if (selectedEmployees === 0) {
            alert('Vui lòng chọn ít nhất một nhân viên!');
            e.preventDefault();
            return;
        }
        
        // Confirm before submitting
        if (!confirm(`Bạn có chắc chắn muốn tính lương cho ${selectedEmployees} nhân viên trong tháng ${month}/${year}?`)) {
            e.preventDefault();
            return;
        }
    });
});
</script>
{% endblock %}
